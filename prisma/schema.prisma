// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  email          String    @unique
  hashedPassword String?
  emailVerified  DateTime?

  firstName   String?
  lastName    String?
  gender      Gender?
  phone       String?
  dateOfBirth String?

  street   String?
  city     String?
  postCode String?
  county   String?
  country  String?

  contactName   String?
  contactNumber String?
  relationship  String?

  role UserRole @default(VISITOR)
  belt Belt?    @default(WHITE)

  // Only required for gym owners / admins
  gymId String? @db.ObjectId
  gym   Gym?    @relation(fields: [gymId], references: [id])

  accessPasses  AccessPass[]
  signedWaivers SignedWaiver[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Gym {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  slug     String   @unique
  name     String
  about    String?
  address  String?
  currency Currency @default(USD)

  stripeAccountId String?
  stripeEnabled   Boolean @default(false)

  dropIn DropIn?
  waiver Waiver?

  users         User[]
  classes       Class[]
  accessPasses  AccessPass[]
  signedWaivers SignedWaiver[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AccessPass {
  id        String           @id @default(auto()) @map("_id") @db.ObjectId
  type      AccessType
  status    AccessPassStatus @default(ACTIVE)
  usedAt    DateTime?
  expiresAt DateTime?


  classId String? @db.ObjectId
  class   Class?  @relation(fields: [classId], references: [id])

  isPaid Boolean @default(false)

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  gymId String @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, gymId, type])
  @@index([userId, gymId, classId])
  @@unique([userId, gymId, classId, status])
}

model DropIn {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  fee      Int
  currency Currency

  qrCode String?

  gymId String @unique @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SignedWaiver {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  waiverText String
  signature  String
  signedAt   DateTime @default(now())

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  gymId    String  @db.ObjectId
  gym      Gym     @relation(fields: [gymId], references: [id])
  waiver   Waiver? @relation(fields: [waiverId], references: [id])
  waiverId String? @db.ObjectId

  @@unique([userId, waiverId])
}

model Class {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  dayOfWeek DayOfWeek
  startTime String
  duration  Int
  isFree    Boolean   @default(false)

  gymId String @db.ObjectId
  gym   Gym    @relation(fields: [gymId], references: [id])

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  accessPasses AccessPass[]
}

model Waiver {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  updatedAt DateTime @updatedAt

  gymId         String         @unique @db.ObjectId
  gym           Gym            @relation(fields: [gymId], references: [id])
  signedWaivers SignedWaiver[]
}

enum AccessPassStatus {
  ACTIVE
  USED
  EXPIRED
  CANCELLED
}

enum UserRole {
  VISITOR
  ADMIN
}

enum Belt {
  WHITE
  BLUE
  PURPLE
  BROWN
  BLACK
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNSPECIFIED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum Currency {
  USD
  GBP
  EUR
}

enum AccessType {
  DROP_IN
  OPEN_MAT
}
